---
title: "Rproj template"
author: "Jouni Vatanen"
date: "`r format(Sys.time(), '%d.%m.%Y')`"
output: 
  html_document: 
    toc: TRUE
    toc_depth: 2
    number_sections: FALSE
    df_print: paged
    code_folding: hide
    css: "./doc/Ilmarinen.css"
editor_options: 
  chunk_output_type: console
---

```{r create-html-document, eval = FALSE}
# Activate to create a html file
rmarkdown::render("Rproj-template.Rmd", "html_document", 
                  output_dir = "./output")
```

```{r setup, echo = FALSE, warning = FALSE, message = FALSE}
# LOAD PACKAGES AND FUNCTIONS
# Create required packages file for the checkpoint
packages <- c(
   "extrafont", "readxl", "tidyverse", "data.table", "fs", "vroom", "lubridate"
   , "knitr", "desctable", "formattable", "rmarkdown", "devtools", "pkgbuild"
  #, "mailR", "quantmod"
  #, "modelr", "broom", "caret"
  #, "grid", "gridExtra", "DT", "tm", "wordcloud", "SnowballC", "stringi"
  #, "keyring", "DBI", "odbc", "dbplyr", "httr", "XML", "jsonlite", "rvest"
  #, "Hmisc", "GGally", "kableExtra", "FactoMineR", "factoextra", "ClustOfVar"
  #, "ggrepel", "pROC", "webshot", "xts", "zoo", "psych", "htmlwidgets", "rJava"
  #, "magrittr", "seasonal", "quan
  )
cat(sprintf("library(%s)", packages), file = "./R/packages.R", sep = "\n")

# Checkpoint installs packages
if (!require("checkpoint")) install.packages("checkpoint"); library(checkpoint)
# use a date few weeks after R.version was released
checkpoint("2019-07-28", R.version = "3.6.1", 
           checkpointLocation = Sys.getenv("USERPROFILE"))

# Load usual packages, custom functions for the project and general functions
source("./R/packages.R")
source("./R/functions.R")
install_github("JouniVatanen/stools"); library(stools)
install_github("JouniVatanen/itools"); library(itools)

# Executes only if rJava is loaded for it to work properly
if ("rJava" %in% .packages()) {
  # Choose your Java path
  java_path <- path(Sys.getenv("USERPROFILE"), "Tools/Java/jre")
  # Set Java path if it exists
  if (dir_exists(java_path)) options(java.home = java_path)
  else stop("Define correct path for Java in java.path")
}

# PROJECT VARIABLES



# GENERAL OPTIONS AND VARIABLES
# Load data from Jmisc package
#data("fi_postnumber_2016", package = "Jmisc")
#data("fi_people_names", package = "Jmisc")

# Check if Arial fonts are installed and install, if they are not
if (!any(match(fonts(), "Arial"), na.rm = TRUE)) {
  font_import(pattern = "arial.*", prompt = FALSE)
}

# Set knitr options like NA values for tables and locale
opts_chunk$set(warning = F, error = F, message = F, echo = F)
options(knitr.kable.NA = "", encoding = "UTF-8")

# Change options eg. match Finnish locale
locale_fi <- locale(date_names = "fi", decimal_mark = ",", grouping_mark = " ")
na_values <- c("null", "'null'", "", ".", "\"\"", "<NA>", "NA", "en osaa sanoa")

# Use keyring, if it is loaded
if ("keyring" %in% .packages()) {
  # Set variables to be used in keyring.
  kr_service <- "my_service"
  kr_username <- "my_username"

  # If keyring service is not yet defined, then define password
  if (is.na(key_list(kr_service)[1, 2])) {
    warning("Check the kr_username and save your password to keyring")
    key_set(service = kr_service, username = kr_username)
  }
}
```

# Johdanto

Miksi tämä työ on tehty ja joitain tarvittavia linkkejä

```{r load-data, eval = FALSE}
# Load data
# Load single csv
df <- fread("./data/data.csv", select = col_select, encoding = "UTF-8") %>% 

  
# Load single xls/xlsx sheet
df <- read_excel("./data/data.xlsx", .name_repair = clean_names)

# Load multiple xls/xlsx sheets
# Choose sheet names or numbers and load using purr
df <- c("Sheet 1", "Sheet 2", "Sheet 3")
  map_df(~read_excel("./data/data.xlsx", sheet = .x, .name_repair = clean_names))

# Load multiple xls/xlsx files
# Choose patterns for file names and load using purrr
df <- dir_ls("./data", glob = "Osallistujat.*") %>%
  map_df(~read_excel(.x, .name_repair = clean_names))

```

```{r mutate-data, eval = FALSE}
# Mutate and combine data
# Recode and classify
education <- rlang::exprs(
  "1 Ylempi korkeakoulu"                = "Yliopisto/korkeakoulu",
  "2 AMK"                               = "Ammattikorkeakoulu",
  "3 Ylioppilas"                        = "Ylioppilas/opisto",
  "4 Perus-/ ammattikoulu"              = "Kansa-/perus-/keski-/ammattikoulu",
  "5 EOS"                               = "Valitse")

statement <- c(
  "täysin eri mieltä", 
  "jokseenkin eri mieltä", 
  "ei samaa eikä eri mieltä", 
  "jokseenkin samaa mieltä", 
  "täysin samaa mieltä")

satisfaction <- c(
  "erittäin huonosti",
  "huonosti",
  "tyydyttävästi",
  "hyvin",
  "erittäin hyvin")

# If you want to combine many df, then rename, select and give a version name
df %<>%
  mutate(version = "v2018") %>%
  rename() %>%
  select() %>%
  left_join(df_db_2018, by = "id")

# Create a data that contains all the open feedback
df_feedback <- df %>%
  select() %>%
  mutate_all(~if_else(. %in% c(
    "Kyllä, missä asioissa?", 
    "En, mitä tietoa kaipasit?", 
    "Kyllä", 
    "En",
    "Jollain muulla tavalla, miten?", 
    "-", "--"
    ), NA_character_, .)) %>%
  rename_all( ~c(
    "var 1",
    "var 2")) %>%
  gather(2:ncol(.), key = "question", value = "values") %>%
  filter(!is.na(values)) %>%
  arrange(question, values)

# Mutate the data
df_numeric <- df %>%

  # Join area codes
  left_join(
    select(fi_postnumbers_2016, 1, 7), 
    by = "postinumero")) %>%
  
  # Strip information from social security number
  mutate_at(
    vars(HETU), 
    list(gender = ~Jmisc::calc_gender(.), 
         birth_day = ~Jmisc::calc_birth(.))) %>%
  
  # Calculate age
  mutate(age = interval(birth_day, today) / years(1)) %>%
  
  # Change statements to factors and remove EOS
  mutate_at(
    vars(1:3), 
    ~as.numeric(parse_factor(., statement.levels, 
                             na = na_levels, include_na = FALSE))) %>%
  
  # Classify variablesage, pension amount and pension type
  mutate(
    var1 = cut(
      var, 
      c(0, 54.9, 59.9, 62.9, 64, 999), 
      labels = c("", "", "", "", "", "", "")),
    var2 = case_when(
      var %in% c("") ~ "case1",
      var %in% c("") ~ "case2",
      TRUE ~ .)) %>%

  # Generate 0-100 variables
  mutate_at(vars(1), ~ifelse(is.na(.), 0, 100)) %>%
  mutate_at(vars(2), ~case_when(
    is.na(.)     ~ NA_real_,
    . == "Kyllä" ~ 100,
    TRUE         ~ 0)) %>%
  mutate_at(vars(3), ~case_when(
    is.na(.)    ~ NA_real_,
    . == "En"   ~ 0,
    TRUE        ~ 100)) %>%
                            
  # Calculate NPS
  mutate_at(vars(4), list(NPS = ~Jmisc::calc_nps(.))) %>%
  
  # Modify to factors with levels and custom NA values
  mutate_at(vars(5), ~parse_factor(., factor.levels, na = na_values)) %>%
  
  # To factors
  mutate_at(vars(6), ~as.factor(.)) %>%
  
  # Leave only necessary variables
  select(NPS, 1:10)
  
```

```{r create-table, eval = FALSE}
# Create statistics table
# Choose data and columns to factor and group by
df.desc <- Jmisc::desc_stat(df.numeric, c(1:10), c("var1", "var2"))
```

```{r mutate-table, eval = FALSE}
# Mutate statistics table
df_desc %<>%
  
  # Add extra rows
  add_row(Variables = "") %>%
  add_row(Variables = "TAUSTATIEDOT") %>%
  
  # Slice the data to the correct form
  slice(c(1:5, 2, 10)) %>%
  
  # Fix variable names and remove unnecessary variables
  mutate_at(
    vars(Variables), 
    ~stri_replace_all_regex(., c("^Q[0-9 ]{1,7}"), c(""), vectorize_all = F))) %>%
  mutate_at(
    vars(Variables), 
    ~case_when(
      . == "100" ~ "suosittelija",
      . == "0" ~ "neutraali",
      . == "-100" ~ "kriittinen",
      . == "1" ~ "täysin eri mieltä",
      . == "2" ~ "jokseenkin eri mieltä",
      . == "3" ~ "ei samaa eikä eri mieltä",
      . == "4" ~ "jokseenkin samaa mieltä",
      . == "5" ~ "täysin samaa mieltä",
      TRUE ~ .))) %>%
  
  # Rename variables
  rename(
    suosittelija = `100`, 
    neutraali = `0`,
    kriittinen = `-100`) %>%
  
  # Remove futile variables
  select(-starts_with("V1"))
```

```{r data-to-txt, eval = FALSE}
# Export data to txt-file
Jmisc::df_to_txt(df_desc, "./output/desc_table.txt")
Jmisc::df_to_txt(df_feedback, "./output/data_feedback.txt")
Jmisc::df_to_txt(df, "./output/data_cleaned_2018.txt")
```

# Tiivistelmä

Yhteenveto ja johtopäätökset

# Tulokset

## Peruskuvat

```{r create-fig-basic, eval = FALSE}
# Basic plot
# Choose which variables to plot
l <- list(1, 2, c(3:5), 6, 7)

# Edit labels to fit the screen properly
labels <- c("var.name")

# Choose which variables to plot and map the function to a list
plot.basic <- df.desc %>% 
  select(1:2) %>%
  rename_at(1, funs(str_sub(., 1, 30))) %>%
  {map(l, function(x) Jmisc::multiplot_bars(., x, labels))}

# Length of the list for a calculation to correct figure size
# Height of 6 for each row of pictures
len <- as.integer(round(length(plot.basic) / 2, 0) * 3)
```

```{r show-fig-basic, out.width = "100%", fig.height = len}
# Create and show a grid from plots
do.call("grid.arrange", c(plot.basic, ncol = 2))
```

## Tulostaulukko

```{r show-table, eval = FALSE}
# Show table
df_desc %>%
  mutate_at(vars(-1), ~round(., 1)) %>%
  mutate_at(vars(-1), ~if_else(is.na(.), "", .)) %>%
  datatable(rownames = FALSE, extensions = c("Buttons", "FixedColumns"), 
    options = list(
      pageLength = 10, 
      scrollX = TRUE, 
      lengthMenu = list(c(10, -1), list("10", "All")), 
      dom = "Blrtip", buttons = list(
        "copy",  
        list(
          extend = "excel", 
          filename = "Ilmarinen"), 
        list(
          extend = "colvis", 
          text = "Näytä/piilota sarakkeita", 
          columns = ":gt(1)", 
          show = ":lt(2)", 
          hide = ":gt(1)"), 
        list(
          extend = "colvisGroup", 
          text = "Piilota kaikki", 
          show = ":lt(2)", 
          hide = ":gt(1)"))))
```

### Sanapilvi

```{r wordcloud, out.width = "100%"}
# Create remove words list
remove_words <- c("että", "moite", "sitä", "sitä", "sen", "palaute", "fffd", 
                  "hei", "myös")

# Stem and remove stopwords for further analyses
corpus <- Corpus(VectorSource(df.feedback["values"]))
dtm <- TermDocumentMatrix(corpus, control = list(
  removePunctuation = TRUE,
  removeNumbers = TRUE,
  tolower = TRUE,
  stopwords = c(stopwords("finnish"), remove_words),
  stripWhitespace = TRUE))

vec <- sort(rowSums(as.matrix(dtm)), decreasing = TRUE)
df <- df(word = names(vec), freq = vec)

# Create wordcloud and give a random number seed
par(mar = rep(0, 4))
set.seed(31102018)
wordcloud(df$word, df$freq, min.freq = 1, max.words = 200, rot.per = 0, 
          colors = ilmarinen_cols())
```

### Yksittäiset palautteet

```{r include = FALSE}
# This is needed for the feedback work
DT::datatable(df.feedback, extensions = "Buttons",
  options = list(
    pageLength = 5, scrollX = TRUE, dom = "Blrtip",
    buttons = list("copy", list(
      extend = "excel", filename = "Avopalaute"))))
```

```{r results = "asis"}
# All feedback in its own boxes
for (i in unique(df_feedback$question)) {
  
  DT_i <- df_feedback %>%
    dplyr::filter(question == i) %>%
    dplyr::select(values)
  
  cat("\n\n")
  print(htmltools::tagList(
    DT::datatable(DT_i, 
      rownames = FALSE, 
      colnames = c(i), 
      extensions = "Buttons",
      options = list(
        pageLength = 5, scrollX = TRUE, dom = "Blrtip",
        lengthMenu = list(c(5, -1), list('5', 'All')),
        buttons = list("copy", list(
          extend = "excel", filename = "Avopalaute"))))))
  cat("\n\n")
}
```
