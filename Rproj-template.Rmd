---
title: "Rproj template"
author: "Jouni Vatanen"
date: "`r format(Sys.time(), '%d.%m.%Y')`"
output: 
  html_document: 
    toc: TRUE
    toc_depth: 2
    number_sections: FALSE
    df_print: paged
    code_folding: hide
    css: "./doc/Ilmarinen.css"
  html_notebook: 
    code_folding: hide
  word_document:
    reference_docx: "./doc/template.docx"
  powerpoint_presentation:
    reference_doc: "./doc/template.pptx""
editor_options: 
  chunk_output_type: console
---

```{r setup, echo = FALSE, results = "hide", warning = FALSE, error = FALSE, message = FALSE}
# Define names, variables and paths if necessary
csv.data.2018 <- "./data/data-2018.csv"
xls.data.2018 <- "/.data/data-2018.xlsx"
#my.year <- c("2018")

# Select columns to load
col.select <- c(1:10, 13)

# Load (and install) packages
if (!require("pacman")) install.packages("pacman") #pacman loads and installs packages
pacman::p_load("checkpoint") # checkpoint installs packages from a given date for reproduction
checkpoint::checkpoint("2018-08-01") # use the same date when R-3.5.1. was released
pacman::p_load_gh("JouniVatanen/Jmisc") # usermade general custom functions

# Load (and install) usual packages
pacman::p_load("extrafont", "readxl", "tidyverse", "tidyr", "data.table", "magrittr", "lubridate", "knitr", "modelr", "broom", "caret")

# Load (and install) other packages, if necessary
#pacman::p_load("desctable", "Hmisc", "GGally", "kableExtra", "formattable", "gridExtra", "FactoMineR", "factoextra", "ClustOfVar", "psych", "ggrepel", "pROC", "DT", "webshot", "xts")

# When installing extrafont for the first time, install also Arial fonts
#extrafont::font_import(pattern = "Arial.*")

# Load functions and api settings
source("./R/functions.R")

# Define global options FALSE and knitr options
knitr::opts_chunk$set(warning = FALSE, error = FALSE, message = FALSE, echo = FALSE)

# Change knit table option NA to empty
options(knitr.kable.NA = "")
```

```{r knit-document, eval = FALSE}
# Activate to create a html file
rmarkdown::render("Rproj-template.Rmd", 
  output_format = "html_document", 
  output_file = "./output/Rproj-template.html", 
  encoding = "UTF-8")
```

# Johdanto

Tämä on mallipohja muille projekteille. Ajatuksena . 

Ohje lyhyesti:

1. Luo projekti
2. Alusta git
3. Lataa mallipohja githubista osoitteesta
- [SSH-yhteys](https://help.github.com/articles/connecting-to-github-with-ssh/) git@github.com:JouniVatanen/rproj-template.git
- [https-yhteys](https://help.github.com/articles/which-remote-url-should-i-use/#cloning-with-https-urls-recommended)https://github.com/JouniVatanen/rproj-template.git
4. 

```{r load-data, eval = FALSE}
# Load data csv/xlsx
df.2018 <- fread(csv.data.2018, select=col.select, encoding="UTF-8", check.names = TRUE)
df.2018 <- read_excel(xls.data.2018, sheet=1)
```

```{r mutate-data, eval = FALSE}
# Mutate and combine data
# Recode and classify
koulutus.class <- rlang::exprs(
  "1 Ylempi korkeakoulu"                = "Yliopisto/korkeakoulu",
  "2 AMK"                               = "Ammattikorkeakoulu",
  "3 Ylioppilas"                        = "Ylioppilas/opisto",
  "4 Perus-/ ammattikoulu"              = "Kansa-/perus-/keski-/ammattikoulu",
  "5 EOS"                               = "Valitse")

# If you want to combine many df, then rename, select and give a version name
df.2018 %<>%
  mutate(version = "v2018") %>%
  rename() %>%
  select()

# Mutate the data using the same function
df.2018 %<>% my_mutate()

# Combine different data sources and mutate factors to the same levels
# If you combine factor columns, then define those columns
fct.col <- c() 

df.example.all <- bind_rows(df.2018, df.2017) %>%
  mutate_at(vars(one_of(fct.col)), funs(as.factor))
```

```{r data-to-txt, eval = FALSE}
# Export data to txt-file
Jmisc::df_to_txt(df.example, "output/data_example.txt")
```

```{r data-to-desc, eval = FALSE}
# Create basic output to inspect the file
Jmisc::inspect(df.example, "output/desc_example.txt")
```

# Tiivistelmä

Yhteenveto ja johtopäätökset

# Tulokset

## Peruskuvat

```{r fig-cor-01, eval = FALSE}
# Correlation plot
Jmisc::corr_plot(df.2018)
```

```{r fig-basic-01, eval = FALSE}
# Basic plot
#Note: Still needs some work to make better looking mosaic plots
# Load packages
require(GGally)

# Plot matrix of all variables
pl.df <- select(df.2018, c(1:50)) %>% mutate_at(1:50, as.factor)
names(pl.df) <- str_replace_all(names(pl.df), "ö|ä", "")

# Plot pairplot from all the active variables
pl02 <- ggpairs(pl.df, upper = list(discrete = "blank"), lower = list(discrete = ggally_ratio), axisLabels = "none") +
  theme_minimal()

pl02

```

## Tulostaulukko

```{r table-01, eval = FALSE}
# Create table
desc.2018 %>%
  mutate_at(vars(-1), funs(round(., 1))) %>%
  mutate_at(vars(-1), funs(ifelse(is.na(.), "", .))) %>%
  formattable(list(area(2:nrow(.), 2:ncol(.)) ~ color_tile("white","orange"))) %>% 
  as.datatable(rownames = FALSE, extensions = c("Buttons", "FixedColumns"), 
    options = list(
      pageLength = 5, scrollX = TRUE, dom = "Blrtip", buttons = list(
        "copy", "print", list(
          extend = "excel", filename = "Ilmarinen_futurescore"), 
        list(
          extend = "colvis", text = "Näytä/piilota sarakkeita", columns = ":gt(1)"), 
        list(
          extend = "colvisGroup", text = "Piilota kaikki", show = ":lt(2)", hide = ":gt(1)"))))
```
